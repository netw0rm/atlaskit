# Make sure not to use && as a continuation in any of these steps unless you
# pair it with || exit 1 pipelines concats each of these commands into one
# script and runs that if your command in the script list has && joining it,
# and any of the steps fail, the pipeline will still continue.
#
# Please either put those commands in a script in ./build/bin or just place
# them in different items in the list.
#
# i.e. change:
#
#   - foo && bar && baz
#
# to:
#
#   - foo
#   - bar
#   - baz
image: node:7.9.0 # Uses debian 8.7
pipelines:
  branches:
    master:
      - step:
          script:
            - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 0.23.2
            - export PATH=$HOME/.yarn/bin:$PATH
            - yarn global add cloudfront-invalidate-cli@1.2.0
              marky-markdown@8.1.0
              bitbucket-build-status@1.0.2
              npm-run-all@3.1.1
              lerna@2.0.0-rc.4
              semantic-release@6.3.6
              lerna-semantic-release@9.0.7
              indexifier@2.0.0
              @atlassian/prebake-distributor-runner@1.0.2
            - yarn
            - ./build/bin/release.stop.pipeline.if.other.master.running.js
            - lerna bootstrap | cat
            - lerna run lint --stream
            - lerna run test --concurrency=1 --stream

            # Specific to master
            - yarn run release/check/is-workspace-clean --silent
            - yarn run release/check/can-ff --silent || exit 0
            - npm run release
            - run-p -ln "release/registry" "release/storybooks"
            - yarn run release/announce
            - ./build/bin/release.restart.last.stopped.pipeline.js
    invalidate-atlaskit-cache:
      - step:
          script:
            - ./build/bin/cloudfront_invalidate.sh
  default:
    - step:
        caches:
          - nwb-branch
          - lukes-cache
        script:
          - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 0.23.2
          - export PATH=$HOME/.yarn/bin:$PATH

          # required for uploading to cdn, can remove once script is rewritten
          # from https://www.linkedin.com/pulse/installing-openjdk-8-tomcat-debian-jessie-iga-made-muliarsa
          - echo "deb http://ftp.de.debian.org/debian jessie-backports main" >> /etc/apt/sources.list
          - apt-get update
          - apt-get -y install -t jessie-backports openjdk-8-jdk
          - apt-get -y install zip

          - yarn global add cloudfront-invalidate-cli@1.2.0
            marky-markdown@8.1.0
            bitbucket-build-status@1.0.2
            npm-run-all@3.1.1
            lerna@2.0.0-rc.4
            semantic-release@6.3.6
            lerna-semantic-release@9.0.7
            indexifier@2.0.0
            @atlassian/prebake-distributor-runner@1.0.2
          - yarn
          - lerna bootstrap | cat
          # - lerna run lint --stream
          # - lerna run test --concurrency=1 --stream
          - lerna run storybook:static --scope="{@atlaskit/avatar,@atlaskit/button}" # --since $(npm run branch -s)
          - ./build/bin/pr/upload-storybooks.js
definitions:
  caches:
    nwb-branch: node_modules
    lukes-cache: packages